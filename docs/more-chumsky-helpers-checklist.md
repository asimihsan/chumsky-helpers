# Chumsky Helper Roadmap & Checklist

> A living checklist that tracks what is needed.  The list is ordered by dependency, so completing an item unblocks those below it.

---

## Legend

- [ ]  = not started
- [~]  = in progress / PR open
- [x]  = finished & merged to main

> **Tip**: Each helper must ship with
>
> 1. //! module-level docs explaining why it exists & how to reuse it.
> 2. Unit tests (happy & edge cases).
> 3. Property-based tests (proptest) that stress invalid inputs & recovery.
> 4. A public builder (see §Configuration) to tweak language-specific knobs.

---

## Pkl String Support – Refactor & Implementation Plan

> Tracking the phased roadmap (2025-06-23) that will make the string helpers fully compliant with the Pkl specification without code duplication.

| Phase | Status | Deliverable |
| ----- | ------ | ----------- |
| 0 | [ ] | Extract a shared `esc` module with `char_escape` & `unicode_escape` parsers; refactor `literal.rs`, `cooked_string`, and tests to reuse it |
| 1 | [ ] | Implement `cooked_multi_line` helper (triple-quote) + indent strip; expose via `StringParserConfig::cooked_multi_line()` and enable for `Lang::Pkl` / `Lang::Swift` |
| 2 | [ ] | Make interpolation hash-aware: consult `StrState.hash_cnt`, support both `\#(` and future brace variants, and add nested-interpolation handling |
| 3 | [ ] | Full Unicode escape set (`\0`, `\xNN`, `\uNNNN`, `\u{…}`) with ≥0x10FFFF rejection & `unicode_escape` flag wiring |
| 4 | [ ] | Add `StringParserConfig::dial(Lang::Pkl)` preset turning on `strip_indent`, `allow_interpolation`, and `unicode_escape` |
| 5 | [ ] | Delegate `LiteralParserBuilder` double-quoted branch to the new `cooked_string()` helper so escapes live in one place |

### Test Additions

- Unit tests
  - `"\u{26}"` ⇒ `"&"` (single-line cooked)
  - Multi-line cooked with varying indentation (examples from Pkl docs)
  - Custom delimiter with 2 hashes & escape/interp: `##" \\#\#n \#(1 + 1) "##`
- Property tests
  - Round-trip guarantee for random Unicode strings with `n ∈ 0..=3` hashes (raw & cooked)
  - No-panic invariant for arbitrary `Vec<u8>` across all helpers

---

## Core Token Infrastructure

| Status | Task | Notes |
| ------ | ---- | ----- |
| [ ] | token::Token<'src> enum finalised | Shared by all helpers, includes Span integration. |
| [ ] | token::Keyword and token::Punct sub-enums | Generated via bon for compile-time safety. |
| [ ] | lexer::TriviaPolicy trait | Allow consumers to keep/discard whitespace, docs, etc. |

---

## Primitive Parsers (no external state)

| Status | Helper | Description |
| ------ | ------ | ----------- |
| [ ] | whitespace() | Returns Token::Whitespace or gets .ignored() via policy. |
| [ ] | comment() / doc_comment() | Block & line variants; doc comments preserved. |
| [ ] | shebang() | Optional first token, useful for scripts. |
| [ ] | identifier(cfg) | Unicode-aware; rejects keywords supplied by cfg. |
| [ ] | keyword(cfg) | Zero-alloc recognition via perfect-hash set generated by bon. |
| [ ] | punct(cfg) | Longest-match first, list again generated by bon. |
| [ ] | int_literal(radix) | Handles _ separators, returns raw text. |
| [ ] | float_literal() | Optional exponent, rejects underscored edge cases. |
| [ ] | char_escape() | Parses \n, \t, etc., returns char. |
| [ ] | unicode_escape() | Parses \u{…} → char. |

---

## Stateful String Helpers

| Status | Helper | Description |
| ------ | ------ | ----------- |
| [ ] | raw_string(cfg) | Single- & multi-line, hash-delimited raw strings. |
| [ ] | cooked_string(cfg) | Classic escaped strings with full escape set. |
| [ ] | interpolated_string(cfg) | Recognises escape+interpolation; returns Vec<Segment> or token stream. |

### Detailed checklist

| Status | Item | Notes |
| ------ | ---- | ----- |
| [ ] | Indent stripping for multi-line literals | Trim common indent and enforce closer on its own line (Swift/Pkl). |
| [ ] | Hash-aware escape & interpolation prefixes | `\\` → `\\#^n` and `\\(` → `\\#^n(` where *n = hash_cnt*. |
| [ ] | Full escape set | Implement `\\0`, `\\xNN`, `\\uNNNN`, `\\u{…}`; validate ≤ 0x10FFFF; normalise `\\r\\n` → `\\n`. |
| [ ] | Nested interpolation & paren depth | Maintain `StrState.paren_lvl`; allow recursion into nested strings. |
| [ ] | Configurable interpolation braces | Builder exposes `( )`, `{ }`, and Kotlin multi-$ variants. |
| [ ] | Token-level output variant | Emit `StrStart` / `Text` / `Expr` / `StrEnd` with spans for lexer consumers. |
| [ ] | Error recovery & diagnostics | Capture opener span; on unterminated literal emit custom `Rich` referencing both ends; explicit error for >255 hashes. |
| [ ] | Dial-a-language presets | `enum Lang { Swift, Pkl, CSharp11, Kotlin }` pre-configures builder toggles. |
| [ ] | C# 11 triple-quote raw literals | Support `""" text """` (no hashes) with optional indent strip. |
| [ ] | Kotlin multi-$ interpolation | Support choosing how many `$` trigger interpolation. |
| [ ] | StringParserBuilder API | Implement bon-generated builder with per-flag toggles + `.dial(Lang)` presets; ensure backwards compat shims for current free functions. |
| [ ] | Refactor existing tests | Port current unit tests to new `indoc!` + parameterised helpers; introduce `assert_parses_to!` macros. |

---

## Higher-level Composition

| Status | Component | Description |
| ------ | --------- | ----------- |
| [ ] | lexer::LexerBuilder | Fluent bon builder to choose keyword set, punct list, newline policy, etc. |
| [ ] | Automatic semicolon insertion | Kotlin-style newline handling based on TriviaPolicy. |
| [ ] | Error recovery strategy | recover_with(skip_then_retry_until) wrappers around critical helpers. |

---

## Testing Matrix

- **Unit tests**: Prefer parameterised style via `rstest` *or* a small in-crate `case_table!` macro. Raw source samples should be injected with `indoc::indoc!` or `include_str!` to avoid double-escaping.
- **Assertion helpers**: Provide `assert_parses_to!` / `assert_fails!` macros to collapse `.parse(..).into_result()` boiler-plate.
- **Property tests**: Under `tests/prop/`, add fuzzers that ensure:
  - No panic on arbitrary `Vec<u8>` inputs for all string helpers.
  - Round-trip guarantee for valid literals (`parse → serialise → equal`).
  - Recovery terminates within O(input) time.
- **Golden files**: End-to-end lexer output for Pkl, Swift, C#-11, Kotlin snippets stored in `tests/golden/*`.

---

## Documentation

- [ ] Cargo doc coverage ≥ 90 % (measured by cargo-llvm-cov doc --open).
- [ ] README.md badges: docs.rs, Crates.io, CI, coverage.
- [ ] Tutorials: *"From zero to tokens in 5 mins"* and *"Opting-in to interpolation"*.

---

## Configuration via Bon Builder

```rust
let string_parser = StringParserBuilder::new()
    .dial(Lang::Swift)              // pre-sets sensible defaults
    .with_interpolation_braces("( )")
    .strip_indent(true)
    .unicode_escape(true)
    .build();
```

*The `dial()` preset fills the underlying booleans; callers can still override.*

---

## Release Checklist

- [ ] cargo deny check passes.
- [ ] cargo fmt --check & cargo clippy --all-targets --all-features -- -D warnings clean.
- [ ] SemVer-tagged GitHub release with change-log.

---

*Edit this file in every PR to keep the roadmap honest!*
